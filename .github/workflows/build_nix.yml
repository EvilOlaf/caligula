name: "Build and verify"

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: cachix/install-nix-action@v19

      - name: Build package
        run: nix build .

      - uses: actions/upload-artifact@v3
        with:
          name: caligula-bin
          path: result/bin/caligula

  smoke-test:
    name: Smoke test on Ubuntu
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/download-artifact@v3
      with:
        name: caligula-bin
        
    - name: Set permissions on artifact
      run: chmod +x caligula
      
    - name: Ensure the command runs
      run: ./caligula --help
